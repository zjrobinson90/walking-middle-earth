<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journey Through Middle-earth</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.css" />
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            font-family: Arial, sans-serif;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            min-width: 200px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="info-panel">
        <h3>Map Information</h3>
        <div id="debug"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.js"></script>
    <script>
        // Define the valid tile ranges for each zoom level
        const validTileRanges = {
            0: { x: [0, 1], y: [0, 1] },         // 2x2 tiles
            1: { x: [0, 2], y: [0, 2] },         // 3x3 tiles
            2: { x: [0, 5], y: [0, 5] },         // 6x6 tiles
            3: { x: [0, 11], y: [0, 10] }        // 12x11 tiles
        };

        // Custom tile layer with proper bounds checking
        L.TileLayer.BoundedTiles = L.TileLayer.extend({
            getTileUrl: function(coords) {
                const range = validTileRanges[coords.z];
                
                // Check if tile is within valid range
                if (range && 
                    coords.x >= range.x[0] && coords.x <= range.x[1] &&
                    coords.y >= range.y[0] && coords.y <= range.y[1]) {
                    return `https://zjrobinson90.github.io/walking-middle-earth/tiles/${coords.z}/${coords.x}/${coords.y}.jpg`;
                }
                
                // Return transparent pixel for invalid tiles
                return 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
            }
        });

        // Calculate map dimensions based on maximum zoom level
        const tileSize = 256;
        const maxZoomTiles = validTileRanges[3]; // Use zoom level 3's dimensions
        const mapPixels = {
            x: (maxZoomTiles.x[1] + 1) * tileSize,
            y: (maxZoomTiles.y[1] + 1) * tileSize
        };

        // Initialize the map
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: 0,
            maxZoom: 3,
            zoomControl: true,
            attributionControl: false
        });

        // Add the tile layer
        const tileLayer = new L.TileLayer.BoundedTiles('', {
            minZoom: 0,
            maxZoom: 3,
            noWrap: true,
            tileSize: 256,
            bounds: [[0, 0], [mapPixels.y, mapPixels.x]]
        }).addTo(map);

        // Set initial view and bounds
        const center = [mapPixels.y / 2, mapPixels.x / 2];
        map.setView(center, 1);
        map.setMaxBounds([[0, 0], [mapPixels.y, mapPixels.x]]);

        // Debug information
        map.on('zoomend moveend', function() {
            const zoom = map.getZoom();
            const center = map.getCenter();
            const bounds = map.getBounds();
            document.getElementById('debug').innerHTML = `
                Zoom: ${zoom}<br>
                Center: [${center.lat.toFixed(0)}, ${center.lng.toFixed(0)}]<br>
                Current tile range: ${JSON.stringify(validTileRanges[zoom])}
            `;
        });

        // Force initial update
        setTimeout(() => {
            map.invalidateSize();
            map.setView(center, 1, { animate: false });
        }, 100);
    </script>
</body>
</html>
